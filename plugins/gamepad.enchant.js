enchant.Event = enchant.Event || {};
enchant.Event.GAMEPAD = 'gamepad';
// A
enchant.Event.GAMEPAD_A = 'gamepadA';
enchant.Event.GAMEPAD_A_UP = 'gamepadAup';
enchant.Event.GAMEPAD_A_DOWN = 'gamepadAdown';
enchant.Event.GAMEPAD_A_TICK = 'gamepadAtick';
// B
enchant.Event.GAMEPAD_B = 'gamepadB';
enchant.Event.GAMEPAD_B_UP = 'gamepadBup';
enchant.Event.GAMEPAD_B_DOWN = 'gamepadBdown';
enchant.Event.GAMEPAD_B_TICK = 'gamepadBtick';
// X
enchant.Event.GAMEPAD_X = 'gamepadX';
enchant.Event.GAMEPAD_X_UP = 'gamepadXup';
enchant.Event.GAMEPAD_X_DOWN = 'gamepadXdown';
enchant.Event.GAMEPAD_X_TICK = 'gamepadXtick';
// Y
enchant.Event.GAMEPAD_Y = 'gamepadY';
enchant.Event.GAMEPAD_Y_UP = 'gamepadYup';
enchant.Event.GAMEPAD_Y_DOWN = 'gamepadYdown';
enchant.Event.GAMEPAD_Y_TICK = 'gamepadYtick';
// L
enchant.Event.GAMEPAD_L = 'gamepadL';
enchant.Event.GAMEPAD_L_UP = 'gamepadLup';
enchant.Event.GAMEPAD_L_DOWN = 'gamepadLdown';
enchant.Event.GAMEPAD_L_TICK = 'gamepadLtick';
// R
enchant.Event.GAMEPAD_R = 'gamepadR';
enchant.Event.GAMEPAD_R_UP = 'gamepadRup';
enchant.Event.GAMEPAD_R_DOWN = 'gamepadRdown';
enchant.Event.GAMEPAD_R_TICK = 'gamepadRtick';
// ZL
enchant.Event.GAMEPAD_ZL = 'gamepadZL';
enchant.Event.GAMEPAD_ZL_UP = 'gamepadZLup';
enchant.Event.GAMEPAD_ZL_DOWN = 'gamepadZLdown';
enchant.Event.GAMEPAD_ZL_TICK = 'gamepadZLtick';
// ZR
enchant.Event.GAMEPAD_ZR = 'gamepadZR';
enchant.Event.GAMEPAD_ZR_UP = 'gamepadZRup';
enchant.Event.GAMEPAD_ZR_DOWN = 'gamepadZRRdown';
enchant.Event.GAMEPAD_ZR_TICK = 'gamepadZRtick';
// -
enchant.Event.GAMEPAD_MINUS = 'gamepadminus';
enchant.Event.GAMEPAD_MINUS_UP = 'gamepadminusup';
enchant.Event.GAMEPAD_MINUS_DOWN = 'gamepadminusdown';
enchant.Event.GAMEPAD_MINUS_TICK = 'gamepadminustick';
// +
enchant.Event.GAMEPAD_PLUS = 'gamepadplus';
enchant.Event.GAMEPAD_PLUS_UP = 'gamepadplusup';
enchant.Event.GAMEPAD_PLUS_DOWN = 'gamepadplusdown';
enchant.Event.GAMEPAD_PLUS_TICK = 'gamepadplustick';
// LEFT
enchant.Event.GAMEPAD_LEFT = 'gamepadleft';
enchant.Event.GAMEPAD_LEFT_UP = 'gamepadleftup';
enchant.Event.GAMEPAD_LEFT_DOWN = 'gamepadleftdown';
enchant.Event.GAMEPAD_LEFT_TICK = 'gamepadlefttick';
// RIGHT
enchant.Event.GAMEPAD_RIGHT = 'gamepadright';
enchant.Event.GAMEPAD_RIGHT_UP = 'gamepadrightup';
enchant.Event.GAMEPAD_RIGHT_DOWN = 'gamepadrightdown';
enchant.Event.GAMEPAD_RIGHT_TICK = 'gamepadrighttick';
// UP
enchant.Event.GAMEPAD_UP = 'gamepadup';
enchant.Event.GAMEPAD_UP_UP = 'gamepadupup';
enchant.Event.GAMEPAD_UP_DOWN = 'gamepadupdown';
enchant.Event.GAMEPAD_UP_TICK = 'gamepaduptick';
//down
enchant.Event.GAMEPAD_DOWN = 'gamepaddown';
enchant.Event.GAMEPAD_DOWN_UP = 'gamepaddownup';
enchant.Event.GAMEPAD_DOWN_DOWN = 'gamepaddowndown';
enchant.Event.GAMEPAD_DOWN_TICK = 'gamepaddowntick';
//screenshot
enchant.Event.GAMEPAD_SCREENSHOT = 'gamepadscreenshot';
enchant.Event.GAMEPAD_SCREENSHOT_UP = 'gamepadscreenshotup';
enchant.Event.GAMEPAD_SCREENSHOT_DOWN = 'gamepadscreenshotdown';
enchant.Event.GAMEPAD_SCREENSHOT_TICK = 'gamepadscreenshottick';
//home
enchant.Event.GAMEPAD_HOME = 'gamepadhome';
enchant.Event.GAMEPAD_HOME_UP = 'gamepadhomeup';
enchant.Event.GAMEPAD_HOME_DOWN = 'gamepadhomedown';
enchant.Event.GAMEPAD_HOME_TICK = 'gamepadhometick';
//SL-L
enchant.Event.GAMEPAD_SLL = 'gamepadsll';
enchant.Event.GAMEPAD_SLL_UP = 'gamepadsllup';
enchant.Event.GAMEPAD_SLL_DOWN = 'gamepadslldown';
enchant.Event.GAMEPAD_SLL_TICK = 'gamepadslltick';
//SR-L
enchant.Event.GAMEPAD_SRL = 'gamepadsrl';
enchant.Event.GAMEPAD_SRL_UP = 'gamepadsrlup';
enchant.Event.GAMEPAD_SRL_DOWN = 'gamepadsrldown';
enchant.Event.GAMEPAD_SRL_TICK = 'gamepadsrltick';
//SL-R
enchant.Event.GAMEPAD_SLR = 'gamepadslr';
enchant.Event.GAMEPAD_SLR_UP = 'gamepadslrup';
enchant.Event.GAMEPAD_SLR_DOWN = 'gamepadslrdown';
enchant.Event.GAMEPAD_SLR_TICK = 'gamepadslrtick';
//SR-R
enchant.Event.GAMEPAD_SRR = 'gamepadsrr';
enchant.Event.GAMEPAD_SRR_UP = 'gamepadsrrup';
enchant.Event.GAMEPAD_SRR_DOWN = 'gamepadsrrdown';
enchant.Event.GAMEPAD_SRR_TICK = 'gamepadsrrtick';
// LEFT STICK BUTTON
enchant.Event.GAMEPAD_LEFT_STICK_BUTTON = 'gamepadleftstickbutton';
enchant.Event.GAMEPAD_LEFT_STICK_BUTTON_UP = 'gamepadleftstickbuttonup';
enchant.Event.GAMEPAD_LEFT_STICK_BUTTON_DOWN = 'gamepadleftstickbuttondown';
enchant.Event.GAMEPAD_LEFT_STICK_BUTTON_TICK = 'gamepadleftstickbuttontick';
// RIGHT STICK BUTTON
enchant.Event.GAMEPAD_RIGHT_STICK_BUTTON = 'gamepadrightstickbutton';
enchant.Event.GAMEPAD_RIGHT_STICK_BUTTON_UP = 'gamepadrightstickbuttonup';
enchant.Event.GAMEPAD_RIGHT_STICK_BUTTON_DOWN = 'gamepadrightstickbuttondown';
enchant.Event.GAMEPAD_RIGHT_STICK_BUTTON_TICK = 'gamepadrightstickbuttontick';
//Left STICK(アナログスティック)
enchant.Event.LEFT_STICK_MOVED = 'leftstickmoved';
//Right STICK(アナログスティック)
enchant.Event.RIGHT_STICK_MOVED = 'rightstickmoved';


enchant.GamePad = enchant.Class.create(enchant.EventTarget, {
    initialize: function (playerId) {
        var core = enchant.Core.instance;
        enchant.EventTarget.call(this);
        this._playerId = playerId;
        this._buttonPressed = [[], []];

        this.addEventListener(Event.ENTER_FRAME, function (e) {
            var gamepad_list = navigator.getGamepads();

            for (var i = 0; i < gamepad_list.length; i++) {
                var gamepad = gamepad_list[i];
                if (!gamepad) continue;


                if (this._playerId !== undefined) if (this._playerId != i) continue;
                var mapping = gamepad.mapping;
                var buttons = gamepad.buttons;

                //ボタンの動作
                for (var j = 0; j < buttons.length; j++) {
                    var button = buttons[j];
                    if (button.pressed) {
                        this._createDispatchEvent(button, gamepad.axes, "gamepad");
                    }

                    //アナログスティックの動作
                    var leftStickHorizontal = gamepad.axes[0]; //左スティックの横の動き
                    var leftStickVertical = gamepad.axes[1]; //左スティクの縦の動き
                    var rightStickHorizontal = gamepad.axes[2]; //右スティックの横の動き
                    var rightStickVertical = gamepad.axes[3];  //右スティックの縦の動き

                    //勝手にスティックが動く(スティックを放してもaxesが0にならない)現象の対策としてmargin(遊び）を設定
                    var margin = 0.2;
                    if (
                        leftStickHorizontal > margin ||
                        leftStickHorizontal < -margin ||
                        leftStickVertical > margin ||
                        leftStickVertical < -margin) {
                        this._createDispatchEvent(button, [gamepad.axes[0], gamepad.axes[1]], "leftstickmoved");
                    }
                    else if (
                        rightStickHorizontal > margin ||
                        rightStickHorizontal < -margin ||
                        rightStickVertical > margin ||
                        rightStickVertical < -margin) {
                        this._createDispatchEvent(button, [gamepad.axes[2], gamepad.axes[3]], "rightstickmoved");
                    }

                    //各種ボタンの動作
                    // B
                    if (j == 0) {
                        this._dispatchButtonPressedEvent(button, "B", i, j);
                    }
                    // A
                    if (j == 1) {
                        this._dispatchButtonPressedEvent(button, "A", i, j);
                    }
                    // Y
                    if (j == 2) {
                        this._dispatchButtonPressedEvent(button, "Y", i, j);
                    }
                    // X
                    if (j == 3) {
                        this._dispatchButtonPressedEvent(button, "X", i, j);
                    }
                    // L
                    if (j == 4) {
                        this._dispatchButtonPressedEvent(button, "L", i, j);
                    }
                    // R
                    if (j == 5) {
                        this._dispatchButtonPressedEvent(button, "R", i, j);
                    }
                    // ZL
                    if (j == 6) {
                        this._dispatchButtonPressedEvent(button, "ZL", i, j);
                    }
                    // ZR
                    if (j == 7) {
                        this._dispatchButtonPressedEvent(button, "ZR", i, j);
                    }
                    // -
                    if (j == 8) {
                        this._dispatchButtonPressedEvent(button, "minus", i, j);
                    }
                    // +
                    if (j == 9) {
                        this._dispatchButtonPressedEvent(button, "plus", i, j);
                    }
                    // LEFT_STICK
                    if (j == 10) {
                        this._dispatchButtonPressedEvent(button, "leftstickbutton", i, j);
                    }
                    // RIGHT_STICK
                    if (j == 11) {
                        this._dispatchButtonPressedEvent(button, "rightstickbutton", i, j);
                    }
                    // UP
                    if (j == 12) {
                        this._dispatchButtonPressedEvent(button, "up", i, j);
                    }
                    // DOWN
                    if (j == 13) {
                        this._dispatchButtonPressedEvent(button, "down", i, j);
                    }
                    // LEFT
                    if (j == 14) {
                        this._dispatchButtonPressedEvent(button, "left", i, j);
                    }
                    // RIGHT
                    if (j == 15) {
                        this._dispatchButtonPressedEvent(button, "right", i, j);
                    }
                    if (j == 16) {
                        this._dispatchButtonPressedEvent(button, "home", i, j);
                    }
                    if (j == 17) {
                        this._dispatchButtonPressedEvent(button, "screenshot", i, j);
                    }
                    if (j == 18) {
                        this._dispatchButtonPressedEvent(button, "sll", i, j);
                    }
                    if (j == 19) {
                        this._dispatchButtonPressedEvent(button, "srl", i, j);
                    }
                    if (j == 20) {
                        this._dispatchButtonPressedEvent(button, "slr", i, j);
                    }
                    if (j == 21) {
                        this._dispatchButtonPressedEvent(button, "srr", i, j);
                    }
                }
            }
        });
    },
    _dispatchButtonPressedEvent: function (button, eventName, i, j) {
        if (button.pressed) {
            this._createDispatchEvent(button, null, "gamepad" + eventName);
            this._createDispatchEvent(button, null, "gamepad" + eventName + "tick");
            if (this._buttonPressed[i][j] != true) {
                this._createDispatchEvent(button, null, "gamepad" + eventName + "down");
                this._buttonPressed[i][j] = true;
            }
        } else {
            if (this._buttonPressed[i][j] == true) {
                this._createDispatchEvent(button, null, "gamepad" + eventName + "up");
                this._buttonPressed[i][j] = false;
            }
        }
    },
    _createDispatchEvent: function (button, xy, type) {
        e = new Event();
        e.buttons = {};
        e.buttons.pressed = button.pressed;
        e.buttons.value = button.value;
        e.type = type;
        if (xy == null) {
            xy = [0, 0];
        }
        e.stickx = xy[0];
        e.sticky = xy[1];
        this.dispatchEvent(e);
    }
});